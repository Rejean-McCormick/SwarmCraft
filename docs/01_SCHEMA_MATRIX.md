# TextCraft Matrix Schema (`data/matrix.json`)

**Version:** 2.1.0 (Refactored for Specialized Services)
**Status:** Core Definition
**Role:** The Real-Time Project Dashboard

-----

## 1\. Overview

The **Story Matrix** (`data/matrix.json`) is the single source of truth for the current state of the writing project. It serves as the bridge between the physical reality of the file system and the creative intent of the AI Services.

  * **Written By:** `core/scanner.py` (The Senses) & `core/orchestrator.py` (The Logic).
  * **Read By:** **The Architect Service** (to plan next steps) & **The Editor Service** (to target fixes).
  * **Persistence:** This file is persistent. If the application crashes, the Matrix retains the last known state of the narrative.

-----

## 2\. JSON Structure

The Matrix must strictly adhere to the following structure to ensure the Logic layer can parse it without error.

```json
{
  "meta": {
    "project_name": "Project Name",
    "project_status": "ACTIVE",
    "last_scan_timestamp": "ISO-8601 String",
    "version": "2.1"
  },
  "metrics": {
    "total_word_count": 0,
    "chapter_count": 0,
    "narrative_integrity_score": 100
  },
  "content": {
    "ch01": {
      "title": "The Beginning",
      "path": "data/manuscripts/ch01_The_Beginning.md",
      "word_count": 2500,
      "status": "LOCKED",
      "continuity_check": "PASS",
      "last_modified": "ISO-8601 String",
      "editor_notes": []
    },
    "ch02": {
      "title": "The Conflict",
      "path": "data/manuscripts/ch02_The_Conflict.md",
      "word_count": 1200,
      "status": "DRAFTING",
      "continuity_check": "FAIL",
      "last_modified": "ISO-8601 String",
      "editor_notes": ["Character 'Kael' has the wrong sword in Scene 2."]
    }
  },
  "active_task": {
    "assigned_to": "ai_services.narrator",
    "target": "ch02",
    "action": "revise"
  }
}
```

-----

## 3\. Field Definitions

### I. Metadata (`meta`)

Global project tracking variables.

| Field | Type | Description |
| :--- | :--- | :--- |
| `project_status` | **Enum** | The high-level state of the engine.<br>• `ACTIVE`: Standard operation loop.<br>• `PAUSED`: User intervention required.<br>• `COMPLETE`: All chapters LOCKED. |
| `last_scan_timestamp` | String | ISO-8601 timestamp of the last time `scanner.py` successfully ran. |

### II. Metrics (`metrics`)

Quick-access statistics for the Architect's decision-making process.

| Field | Type | Description |
| :--- | :--- | :--- |
| `narrative_integrity_score` | Integer | **0-100**. A heuristic score calculated by the Editor. It drops when `continuity_check` fails in any chapter. |

### III. Content Map (`content`)

The core registry of the story. Keys (e.g., `ch01`) must match the IDs used in the **Story Bible**.

| Field | Type | Description |
| :--- | :--- | :--- |
| `path` | String | Relative path to the physical `.md` file in `data/manuscripts/`. |
| `word_count` | Integer | Physical word count derived by the **Scanner**. |
| `status` | **Enum** | The lifecycle stage of the chapter (See Section 4). |
| `continuity_check` | **Enum** | **The Editor's Seal.**<br>• `PENDING`: Has not been edited yet.<br>• `PASS`: No logical errors found.<br>• `FAIL`: Contradictions detected (requires rework). |
| `editor_notes` | Array | A list of string errors/feedback generated by **The Editor**. |

### IV. Active Task (`active_task`)

State persistence for the Orchestrator loop.

| Field | Type | Description |
| :--- | :--- | :--- |
| `assigned_to` | String | The specific Python module in `ai_services/` currently executing (e.g., `ai_services.narrator`). Used for crash recovery. |
| `target` | String | The chapter ID being worked on (`ch01`). |
| `action` | String | The specific operation (`generate`, `revise`, `scan`). |

-----

## 4\. State Transitions (The Lifecycle)

The `status` field drives the Orchestrator's logic.

1.  **EMPTY:**
      * *Condition:* File does not exist or word count is \< 50.
      * *Action:* Architect assigns **Narrator Service** to Generate.
2.  **DRAFTING:**
      * *Condition:* File exists, word count \> 50, but \< target.
      * *Action:* **Narrator Service** continues writing.
3.  **REVIEW\_READY:**
      * *Condition:* Word count meets target threshold.
      * *Action:* Orchestrator triggers **Editor Service** to Scan.
4.  **REVISION\_NEEDED:**
      * *Condition:* Editor returned `continuity_check: FAIL`.
      * *Action:* **Narrator Service** is assigned to fix specific `editor_notes`.
5.  **LOCKED:**
      * *Condition:* Editor returned `continuity_check: PASS`.
      * *Action:* No further AI modifications allowed.

-----

## 5\. Logic Mapping

  * **The Scanner** updates `word_count`, `path`, and `last_modified` strictly based on file system reality.
  * **The Editor Service** updates `continuity_check` and `editor_notes` after validation passes.
  * **The Orchestrator** updates `status` and `active_task` based on the combination of the above.