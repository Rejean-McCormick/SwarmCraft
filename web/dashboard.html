<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Swarm Dashboard</title>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --bg-card: #1c2128;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-yellow: #d29922;
            --accent-red: #f85149;
            --accent-purple: #a371f7;
            --border-color: #30363d;
            --border-muted: #21262d;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        .dashboard { display: grid; grid-template-columns: 280px 1fr 350px; grid-template-rows: 60px 1fr; height: 100vh; }
        header {
            grid-column: 1 / -1;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
        }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo h1 { font-size: 1.25rem; font-weight: 600; }
        .logo-icon { width: 32px; height: 32px; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); border-radius: 8px; }
</style>
</head>
<body>
<div class="dashboard">
    <header>
        <div class="logo">
            <div class="logo-icon"></div>
            <h1>Agent Swarm Dashboard</h1>
        </div>
        <div class="header-status">
            <span id="connectionStatus" class="status-badge disconnected">‚óè Disconnected</span>
        </div>
    </header>

    <!-- Sidebar: Agents Panel -->
    <aside class="sidebar">
        <div class="panel">
            <div class="panel-header">
                <h2>ü§ñ Active Agents</h2>
                <span id="agentCount" class="badge">0</span>
            </div>
            <div id="agentsList" class="agents-list">
                <!-- Agents will be populated here -->
            </div>
        </div>
        <div class="panel">
            <div class="panel-header">
                <h2>üìã Tasks</h2>
                <span id="taskCount" class="badge">0</span>
            </div>
            <div id="tasksList" class="tasks-list">
                <!-- Tasks will be populated here -->
            </div>
        </div>
    </aside>

    <!-- Main: Chat Area -->
    <main class="main-content">
        <div class="chat-container">
            <div id="messages" class="messages">
                <!-- Messages will be populated here -->
            </div>
            <div class="input-area">
                <input type="text" id="messageInput" class="message-input" placeholder="Type a message..." disabled>
                <button id="sendBtn" class="send-btn" disabled>Send</button>
            </div>
        </div>
    </main>

    <!-- Right Panel: DevPlan -->
    <aside class="right-panel">
        <div class="panel devplan-panel">
            <div class="panel-header">
                <h2>üìù Master Plan</h2>
                <button id="refreshPlan" class="icon-btn" title="Refresh">‚Üª</button>
            </div>
            <div id="devplanContent" class="devplan-content">
                <p class="placeholder">No master plan yet. The Architect will create one during planning phase.</p>
            </div>
        </div>
        <div class="panel files-panel">
            <div class="panel-header">
                <h2>üìÅ Project Files</h2>
                <button id="refreshFiles" class="icon-btn" title="Refresh">‚Üª</button>
            </div>
            <div id="filesTree" class="files-tree">
                <p class="placeholder">No files yet.</p>
            </div>
        </div>
    </aside>
</div>

<style>
    .sidebar, .right-panel {
        background: var(--bg-secondary);
        border-right: 1px solid var(--border-color);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
    .right-panel { border-right: none; border-left: 1px solid var(--border-color); }
    .panel {
        padding: 16px;
        border-bottom: 1px solid var(--border-color);
    }
    .panel:last-child { border-bottom: none; flex: 1; }
    .panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
    }
    .panel-header h2 { font-size: 0.875rem; font-weight: 600; color: var(--text-secondary); }
    .badge {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.75rem;
    }
    .icon-btn {
        background: none;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        padding: 4px 8px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.875rem;
    }
    .icon-btn:hover { background: var(--bg-tertiary); color: var(--text-primary); }
    
    /* Agents List */
    .agents-list { display: flex; flex-direction: column; gap: 8px; }
    .agent-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 12px;
    }
    .agent-card .agent-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .agent-avatar {
        width: 28px; height: 28px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 0.75rem; font-weight: 600;
        color: white;
    }
    .agent-name { font-weight: 500; font-size: 0.875rem; }
    .agent-role { font-size: 0.75rem; color: var(--text-muted); }
    .agent-status {
        display: inline-flex; align-items: center; gap: 4px;
        font-size: 0.75rem; padding: 2px 6px;
        border-radius: 4px; margin-top: 6px;
    }
    .agent-status.idle { background: rgba(139, 148, 158, 0.2); color: var(--text-secondary); }
    .agent-status.working { background: rgba(63, 185, 80, 0.2); color: var(--accent-green); }
    .agent-task { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    /* Tasks List */
    .tasks-list { display: flex; flex-direction: column; gap: 6px; max-height: 200px; overflow-y: auto; }
    .task-item {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 8px 10px;
        font-size: 0.8rem;
    }
    .task-item .task-status { font-size: 0.7rem; margin-bottom: 4px; }
    .task-item .task-desc { color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .task-status.pending { color: var(--accent-yellow); }
    .task-status.in_progress { color: var(--accent-blue); }
    .task-status.completed { color: var(--accent-green); }
    .task-status.failed { color: var(--accent-red); }
</style>

<style>
    /* Main Chat Area */
    .main-content { display: flex; flex-direction: column; background: var(--bg-primary); }
    .chat-container { flex: 1; display: flex; flex-direction: column; }
    .messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
    .message {
        display: flex; gap: 12px;
        padding: 12px 16px;
        background: var(--bg-secondary);
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }
    .message.system { background: rgba(88, 166, 255, 0.1); border-color: var(--accent-blue); }
    .message.human { background: rgba(63, 185, 80, 0.1); border-color: var(--accent-green); }
    .message .avatar {
        width: 36px; height: 36px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-weight: 600; font-size: 0.875rem;
        flex-shrink: 0;
    }
    .message-body { flex: 1; min-width: 0; }
    .message-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
    .message-sender { font-weight: 600; color: var(--accent-blue); }
    .message-time { font-size: 0.75rem; color: var(--text-muted); }
    .message-content { color: var(--text-primary); line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; }
    .message-content code { background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px; font-family: monospace; }
    
    .input-area {
        padding: 16px;
        border-top: 1px solid var(--border-color);
        display: flex; gap: 12px;
        background: var(--bg-secondary);
    }
    .message-input {
        flex: 1;
        padding: 12px 16px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 0.9rem;
        outline: none;
    }
    .message-input:focus { border-color: var(--accent-blue); }
    .message-input::placeholder { color: var(--text-muted); }
    .send-btn {
        padding: 12px 24px;
        background: var(--accent-blue);
        border: none;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        cursor: pointer;
    }
    .send-btn:hover { opacity: 0.9; }
    .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* DevPlan Panel */
    .devplan-panel { flex: 2; }
    .devplan-content {
        font-size: 0.8rem;
        line-height: 1.6;
        color: var(--text-secondary);
        max-height: 400px;
        overflow-y: auto;
        white-space: pre-wrap;
        font-family: monospace;
        background: var(--bg-card);
        padding: 12px;
        border-radius: 6px;
    }
    .files-panel { flex: 1; }
    .files-tree {
        font-size: 0.8rem;
        font-family: monospace;
        color: var(--text-secondary);
        white-space: pre;
        overflow-x: auto;
        background: var(--bg-card);
        padding: 12px;
        border-radius: 6px;
        max-height: 250px;
        overflow-y: auto;
    }
    .placeholder { color: var(--text-muted); font-style: italic; font-family: inherit; }
    
    /* Status Badge */
    .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 500; }
    .status-badge.connected { background: rgba(63, 185, 80, 0.2); color: var(--accent-green); }
    .status-badge.disconnected { background: rgba(248, 81, 73, 0.2); color: var(--accent-red); }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-tertiary); }
    ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
</style>

<!-- Login Modal -->
<div id="loginModal" class="modal-overlay">
    <div class="modal">
        <h2>üöÄ Join the Swarm</h2>
        <p>Enter your name to interact with the AI agent swarm</p>
        <input type="text" id="usernameInput" placeholder="Your name" maxlength="30" autofocus>
        <button id="joinBtn" class="join-btn">Enter Dashboard</button>
    </div>
</div>

<style>
    .modal-overlay {
        position: fixed; inset: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex; align-items: center; justify-content: center;
        z-index: 1000;
    }
    .modal-overlay.hidden { display: none; }
    .modal {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 32px;
        width: 90%; max-width: 400px;
        text-align: center;
    }
    .modal h2 { margin-bottom: 8px; font-size: 1.5rem; }
    .modal p { color: var(--text-secondary); margin-bottom: 20px; }
    .modal input {
        width: 100%;
        padding: 12px 16px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 1rem;
        margin-bottom: 16px;
        outline: none;
    }
    .modal input:focus { border-color: var(--accent-blue); }
    .join-btn {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
        border: none;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
    }
    .join-btn:hover { opacity: 0.9; }
</style>

<script>
const WS_URL = `ws://${window.location.hostname || 'localhost'}:8765`;
let ws = null;
let username = '';
let userId = '';

// DOM Elements
const loginModal = document.getElementById('loginModal');
const usernameInput = document.getElementById('usernameInput');
const joinBtn = document.getElementById('joinBtn');
const messagesEl = document.getElementById('messages');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const connectionStatus = document.getElementById('connectionStatus');
const agentsList = document.getElementById('agentsList');
const tasksList = document.getElementById('tasksList');
const agentCount = document.getElementById('agentCount');
const taskCount = document.getElementById('taskCount');
const devplanContent = document.getElementById('devplanContent');
const filesTree = document.getElementById('filesTree');

// Agent colors
const agentColors = {
    'Bossy McArchitect': '#a371f7',
    'Codey McBackend': '#58a6ff',
    'Pixel McFrontend': '#f778ba',
    'Bugsy McTester': '#3fb950',
    'Deployo McOps': '#d29922',
    'Checky McManager': '#79c0ff',
    'Docy McWriter': '#ff7b72',
    'System': '#8b949e'
};

function getAgentColor(name) {
    return agentColors[name] || '#58a6ff';
}

function getInitials(name) {
    return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatTime(timestamp) {
    return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}
</script>

<script>
// Join chat
joinBtn.onclick = () => {
    const name = usernameInput.value.trim();
    if (!name) { usernameInput.focus(); return; }
    username = name;
    loginModal.classList.add('hidden');
    connect();
};
usernameInput.onkeypress = (e) => { if (e.key === 'Enter') joinBtn.click(); };

// Connect to WebSocket
function connect() {
    connectionStatus.textContent = '‚óè Connecting...';
    connectionStatus.className = 'status-badge disconnected';
    
    ws = new WebSocket(WS_URL);
    
    ws.onopen = () => {
        ws.send(JSON.stringify({ username }));
    };
    
    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleMessage(data);
    };
    
    ws.onclose = () => {
        connectionStatus.textContent = '‚óè Disconnected';
        connectionStatus.className = 'status-badge disconnected';
        messageInput.disabled = true;
        sendBtn.disabled = true;
        setTimeout(() => { if (ws.readyState !== WebSocket.OPEN) connect(); }, 3000);
    };
    
    ws.onerror = () => {
        connectionStatus.textContent = '‚óè Error';
        connectionStatus.className = 'status-badge disconnected';
    };
}

function handleMessage(data) {
    switch (data.type) {
        case 'welcome':
            userId = data.data.user_id;
            connectionStatus.textContent = '‚óè Connected';
            connectionStatus.className = 'status-badge connected';
            messageInput.disabled = false;
            sendBtn.disabled = false;
            if (data.data.history) {
                data.data.history.forEach(msg => addMessage(msg));
                scrollToBottom();
            }
            if (data.data.status) updateStatus(data.data.status);
            break;
        case 'message':
            addMessage(data.data);
            scrollToBottom();
            break;
        case 'status':
            updateStatus(data.data);
            break;
    }
}

function addMessage(msg) {
    const div = document.createElement('div');
    div.className = 'message';
    if (msg.role === 'system' || msg.message_type === 'join' || msg.message_type === 'leave') {
        div.classList.add('system');
    } else if (msg.role === 'human') {
        div.classList.add('human');
    }
    
    const color = getAgentColor(msg.sender_name);
    const initials = getInitials(msg.sender_name);
    const time = formatTime(msg.timestamp);
    
    div.innerHTML = `
        <div class="avatar" style="background: ${color}">${initials}</div>
        <div class="message-body">
            <div class="message-header">
                <span class="message-sender" style="color: ${color}">${escapeHtml(msg.sender_name)}</span>
                <span class="message-time">${time}</span>
            </div>
            <div class="message-content">${escapeHtml(msg.content)}</div>
        </div>
    `;
    messagesEl.appendChild(div);
}

function scrollToBottom() {
    messagesEl.scrollTop = messagesEl.scrollHeight;
}
</script>

<script>
function updateStatus(status) {
    // Update agents
    if (status.active_agents) {
        agentCount.textContent = status.active_agents.length;
        agentsList.innerHTML = status.active_agents.map(agent => {
            const color = getAgentColor(agent.name);
            const initials = getInitials(agent.name);
            const statusClass = agent.status === 'working' ? 'working' : 'idle';
            const statusText = agent.status === 'working' ? '‚ö° Working' : 'üí§ Idle';
            const taskText = agent.current_task_id ? `Task: ${agent.current_task_id.substring(0, 8)}...` : '';
            
            return `
                <div class="agent-card">
                    <div class="agent-header">
                        <div class="agent-avatar" style="background: ${color}">${initials}</div>
                        <div>
                            <div class="agent-name">${escapeHtml(agent.name)}</div>
                            <div class="agent-role">${escapeHtml(agent.persona || '')}</div>
                        </div>
                    </div>
                    <div class="agent-status ${statusClass}">${statusText}</div>
                    ${taskText ? `<div class="agent-task">${taskText}</div>` : ''}
                </div>
            `;
        }).join('');
    }
}

function updateTasks(tasks) {
    taskCount.textContent = tasks.length;
    if (tasks.length === 0) {
        tasksList.innerHTML = '<p class="placeholder">No tasks yet.</p>';
        return;
    }
    
    tasksList.innerHTML = tasks.slice(-10).map(task => {
        const statusClass = task.status.replace('_', '-');
        const statusIcons = { pending: '‚è≥', in_progress: 'üîÑ', completed: '‚úÖ', failed: '‚ùå' };
        const icon = statusIcons[task.status] || '‚ùì';
        
        return `
            <div class="task-item">
                <div class="task-status ${statusClass}">${icon} ${task.status}</div>
                <div class="task-desc" title="${escapeHtml(task.description)}">${escapeHtml(task.description.substring(0, 50))}${task.description.length > 50 ? '...' : ''}</div>
            </div>
        `;
    }).join('');
}

function updateDevplan(content) {
    devplanContent.textContent = content;
}

function updateFiles(tree) {
    filesTree.textContent = tree;
}

// Send message
function sendMessage() {
    const content = messageInput.value.trim();
    if (!content || !ws || ws.readyState !== WebSocket.OPEN) return;
    
    ws.send(JSON.stringify({ type: 'chat', content }));
    messageInput.value = '';
    messageInput.focus();
}

sendBtn.onclick = sendMessage;
messageInput.onkeypress = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };

// Request status updates periodically
setInterval(() => {
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'status' }));
    }
}, 5000);

// Keep connection alive
setInterval(() => {
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'ping' }));
    }
}, 30000);

// Refresh buttons
document.getElementById('refreshPlan').onclick = () => {
    if (ws && ws.readyState === WebSocket.OPEN) {
        devplanContent.textContent = 'Refreshing...';
        ws.send(JSON.stringify({ type: 'get_devplan' }));
    }
};

document.getElementById('refreshFiles').onclick = () => {
    if (ws && ws.readyState === WebSocket.OPEN) {
        filesTree.textContent = 'Refreshing...';
        ws.send(JSON.stringify({ type: 'get_files' }));
    }
};

// Fetch all data periodically
function fetchAllData() {
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'status' }));
        ws.send(JSON.stringify({ type: 'get_tasks' }));
        ws.send(JSON.stringify({ type: 'get_devplan' }));
        ws.send(JSON.stringify({ type: 'get_files' }));
    }
}

// Fetch data every 5 seconds
setInterval(fetchAllData, 5000);

// Initial fetch after connection
setTimeout(fetchAllData, 1000);
</script>
</body>
</html>
